# Project Progress

## Current Phase

- Phase 6: MVP Hardening for Low-cost Host
- Status: In Progress
- Started: 2026-02-23

## Phase Tracker

| Phase | Name | Status | Started | Completed | Notes |
|---|---|---|---|---|---|
| 0 | Governance and Planning Baseline | Done | 2026-02-22 | 2026-02-22 | Repo and documentation bootstrap complete. |
| 1 | Core Runtime Skeleton | Done | 2026-02-22 | 2026-02-22 | Gateway/worker runtime, file-backed queue, contracts, and test suite completed. |
| 2 | WhatsApp Ingress and Async UX | Done | 2026-02-22 | 2026-02-22 | Baileys payload normalization, dedupe, async status notifications, and phase tests completed. |
| 3 | Memory v1 | Done | 2026-02-22 | 2026-02-22 | Markdown canonical memory, SQLite FTS index, retrieval APIs, and evaluation smoke tests completed. |
| 4 | External Skill Integration Contract | Done | 2026-02-22 | 2026-02-22 | Allowlisted git install pinned to commit SHA, CLI runner contract, and security policy tests completed. |
| 5 | Built-in Reminders and Notes + Job Controls | Done | 2026-02-22 | 2026-02-22 | Added reminder/task/note commands, approval gating, and job status/cancel/retry control flows with test coverage. |
| 6 | MVP Hardening for Low-cost Host | In Progress | 2026-02-23 | - | Codex app-server auth/runtime wired for web + WhatsApp command flow (`/auth connect/status/limits/disconnect`) with OAuth-first chat turns and OpenAI API key fallback. Added restart-safe stale-thread recovery, boot-time auth status visibility in web console, persisted auth telemetry (`lastLogin`/disconnect/status checks) across restarts, richer UI in-flight/status ergonomics with newest-first console option, and first real Baileys live runtime wiring (`/v1/whatsapp/live/status/connect/disconnect`) with inbound token protection/reconnect controls, status-driven QR onboarding, required-prefix + sender-allowlist gating, optional self-message mode for one-number testing, and a guided in-UI WhatsApp setup flow for easier onboarding. Latest updates add direct QR image rendering in `/ui`, a QR generation cap per connect window (manual reconnect required after limit), auto-refresh live status polling so QR/raw payload stay current without manual status clicks, backend-generated QR image payloads to remove CDN dependency, live inbound chat reply relay back to WhatsApp so `/alfred ...` messages receive responses on device, source-level observability cards/change logs in `/ui` for Gateway/Auth/WhatsApp/Memory tracking, a persisted unified interaction stream API/UI feed for cross-channel inbound/outbound/system events, WhatsApp auth-session persistence across gateway restarts by removing implicit logout on runtime stop, real-time SSE stream delivery with polling fallback, persisted WhatsApp-JID to auth-session routing for deterministic OAuth/LLM profile selection, history-sync noise filtering (non-`notify`/stale/duplicate suppression) with accepted-vs-ignored counters in live status to control context bloat, bounded stream retention/noise suppression controls, per-request auth preference selection in `/ui`, explicit no-backend chat guidance, memory-aware prompt injection with source references, persisted-session continuity via transcript view + bounded recent-turn context injection, transcript overflow containment (`pre-wrap` + forced word breaks), fixed transcript max width cap (`800px`), explicit dedicated transcript-frame wrapper, day-scoped transcript filtering (`since`/`until` via date picker, default today) to keep transcript views lightweight, heartbeat reliability controls (persistent heartbeat state, active-hour/idle-queue gating, deduped alerts, heartbeat APIs, `/ui` operator controls, and explicit alerts for auth disconnect, WhatsApp disconnect, and long-running jobs), full `@lid` live chat path compatibility for both inbound parsing and outbound reply relay, consolidated transcript view controls (`All sessions`) with non-overwriting heartbeat form edits during polling, and a new capability-policy baseline (approval-by-default controls, workspace-scoped `/write`, `/web` command path, notes-only write guardrails, env-managed policy flags) now extended with provider-routed web search (`searxng`, `openai`, `brave`, `perplexity`, `brightdata`, `auto`) for `/web --provider=...` execution with SearXNG as default plus optional BrightData comparative path, tokenless yes/no approval resolution for pending actions, explicit pending-approval visibility/resolve paths (`/approval pending`, `/v1/approvals/pending`, `/v1/approvals/resolve`), explicit in-flight progress notifications for long-running `/web` requests, worker-routed long-task execution with progress reporting (`status?` support) and paged `#next` response continuation, planner-first intent routing with confidence-based clarification fallback, balanced approval mode defaults, markdown-driven system-prompt loading for Alfred identity/capabilities/policies, planner-trace stream events (`STREAM_PLANNER_TRACE`) for intent/action observability, locked gateway-as-orchestrator/worker-as-execution architecture decision, durable run-ledger/state-machine tracing (`/v1/runs`, `/v1/runs/:runId`) for per-turn phase visibility, supervisor fan-out parent/child tracking (`/supervisors` APIs + `/supervise web`) with bounded child budgets/timeouts/retries, configurable worker concurrency (`WORKER_CONCURRENCY`), reduced chat-noise progress notifications (throttled intermediate updates with concise running/final messages), and Memory V2 checkpointing/class-aware recall (`/v1/memory/checkpoints/status`, decision/task boundary checkpoints, class-tagged compaction metadata). Remaining: artifact/log retention workers, backup reminders, CI, performance tuning. |

## Recent Task Updates

- 2026-03-01: Fixed planner local-ops precedence so command-like operational requests are checked against local-ops approval routing before worker research delegation, preventing SearXNG/service-control requests from being misrouted into `agentic_turn` web-search jobs.
- 2026-03-01: Added temporary execution-routing debug surface: new endpoint `POST /v1/debug/execution-policy` returns command/approval detection, planner output, delegation policy (forced vs requested), and predicted route so we can inspect routing behavior without replaying full turns.
- 2026-03-01: Expanded planner trace observability in conversation stream metadata with `plannerWillDelegateWorker`, `plannerForcedWorkerDelegation`, and `plannerDelegationReason` to make delegation decisions visible per turn.
- 2026-03-01: Generalized planner-to-executor delegation policy so worker-required intents and attachment side-effect flows are force-routed to worker even when planner emits inconsistent `needsWorker=false`, reducing per-feature routing drift.
- 2026-03-01: Fixed a critical planner/runtime mismatch causing `web_research` plans to fall through to `run_chat_turn` (reasoning-only) when planner returned `needsWorker=false`; gateway now force-delegates `web_research` intents with query payloads to worker execution.
- 2026-03-01: Fixed approval UX parsing so natural-language acknowledgements like `approve search` are no longer interpreted as approval-token commands; token command parsing now accepts explicit token-like values only.
- 2026-03-01: Fixed status intent handling so planner `status_query` always returns deterministic active-job state (`Latest job ...` or `No active long-running job...`) instead of falling back into chat-turn responses.
- 2026-03-01: Hardened chat safety + local ops routing: `run_chat_turn` is now explicitly reasoning-only across Codex/Responses backends (`executionMode=reasoning_only`), natural-language local operation requests are converted into approval-gated `shell_exec` proposals, and shell execution now enforces allowlisted cwd roots before any command can run.
- 2026-03-01: Added shell scope/operator ergonomics updates with `ALFRED_SHELL_ALLOWED_DIRS` config wiring, `--cwd` support on `/shell` and `/exec`, and unit coverage updates for parser/config/local-ops approval flow plus worker progress-event timing stability.
- 2026-02-28: Consolidated architecture direction into canonical docs by adding `docs/architecture_principles.md` and wiring cross-links from vision/plan/features/ADR so runtime guidance remains language-agnostic and durable (`minimal core`, `gateway control plane`, `typed safety-tier tools`, `hybrid execution`, `worker execution plane`, `policy-first security`, `observability-first`).
- 2026-02-28: Fixed planner-to-router mismatch causing `needsWorker=true` tasks with `intent=command` to run in chat mode; gateway now delegates these plans to worker/run-spec paths, restoring attachment/retry execution behavior for WhatsApp task flows.
- 2026-02-28: Added `docs/terminal_file_explorer_recommendations.md` with a concise macOS terminal file-tree recommendation brief: confirmed iTerm2 has no native file-tree explorer pane and documented built-in alternatives (Warp, Wave Terminal, Electerm) plus iTerm2-compatible TUI options (Yazi, Ranger) with source links.
- 2026-02-27: Upgraded agentic worker execution to a budget-aware loop (goal normalization, evidence-coverage fallback retrieval, ranking JSON repair, heuristic ranking fallback, and concise synthesis fallback) so research turns degrade gracefully instead of returning raw-link dumps or link-as-answer recommendations.
- 2026-02-27: Hardened worker operations with retry/watchdog controls: retryable failures now auto-requeue within `maxRetries`, queue retries persist `retryAttempt`, stale running/cancelling jobs are recovered via watchdog timeouts, and worker progress notifications reduce duplicate rapid-fire updates while retaining phase transitions.
- 2026-02-27: Updated approval and memory defaults for better day-to-day UX: approval copy now defaults to `yes/no` guidance with optional explicit token usage, and memory compaction default interval moved to daily (`86400000`) across config/service/env/test surfaces.
- 2026-02-27: Implemented ToolSpec v1 + centralized tool policy engine (`apps/gateway-orchestrator/src/orchestrator/tool_policy_engine.ts`) and wired gateway command policy checks through typed tool decisions (`web.search`, `file.write`, `file.send`, `shell.exec`) with safety-tier metadata emitted in tool-usage observability events.
- 2026-02-27: Normalized the turn loop with explicit phase handler modules (`runDirectivesPhase`, `runPlanPhase`, `runPolicyPhase`, `runRoutePhase`, `runPersistPhase`, `runDispatchPhase`) and rewired gateway orchestration paths to use those handlers for consistent phase markers and cleaner control-plane flow.
- 2026-02-27: Unified shell/wasm execution governance under a shared sandbox policy surface (`apps/gateway-orchestrator/src/orchestrator/sandbox_policy.ts`) and wired gateway/config/tool-policy contracts to consume that single capability layer (`shellEnabled`, `wasmEnabled`) with dedicated unit coverage.
- 2026-02-27: Added a unified channel submission contract (`apps/gateway-orchestrator/src/orchestrator/channel_submission.ts`) so web and WhatsApp ingress both carry normalized origin metadata (`channelId/channelContextId/provider/transport/messageId`) into gateway turns before orchestration starts.
- 2026-02-27: Improved long-run UX and observability: agentic worker progress now emits human-readable in-flight updates more frequently (planning/source-gathering/retrying/analyzing), fallback responses after synthesis timeout now return a concise shortlist + provisional recommendation instead of raw provider dump, and `/health` now includes active job details (job id/status/worker/progress) surfaced in UI source cards.
- 2026-02-27: Locked channel/control-plane architecture in docs: channels (WhatsApp/Web/TUI/future) are transport lanes only, and all normalization/planning/policy/routing/persistence starts at gateway; added explicit WhatsApp 12-step reference flow and linked it from vision/plan/features.
- 2026-02-27: Added ADR lock for architecture direction (`docs/adr/0001-gateway-control-plane-and-agentic-runtime.md`) to formalize gateway-as-control-plane, channel-as-transport, agentic-by-default execution, selective structured runs, and worker-as-execution-plane semantics.
- 2026-02-27: Implemented evidence-backed agentic execution updates for research turns: worker progress events now carry `phase/details` metadata, gateway/UI health now surface active job phase context, `agentic_turn` now does SearXNG-first retrieval with weak-coverage fallback and rank-first synthesis, ambiguity now returns clarification prompts, and fallback recommendations are derived from ranked candidates instead of first-link selection.
- 2026-02-27: Hardened web-search reliability for agentic turns by adding an explicit OpenAI provider timeout in `WebSearchService`; when `provider=auto` and OpenAI/Codex stalls, search now falls through to SearXNG instead of consuming the full agentic turn budget.
- 2026-02-27: Implemented hybrid runtime path in code: planner/heuristic long research now queues `agentic_turn` by default (instead of deterministic `web_search`), worker executes search + synthesis loop with fallback + retries/time budgets, and new worker unit tests cover both synthesis-success and fallback behavior.
- 2026-02-27: Updated architecture direction to explicitly lock hybrid execution behavior: agentic mode remains default for unknown tasks, while structured RunSpec mode is applied selectively for high-risk or repeatable workflows.
- 2026-02-27: Locked an explicit agentic product direction in docs (`docs/agentic_vision.md`) and linked it from identity/plan/features so roadmap decisions prioritize natural-language planning plus tool-mediated execution over command-only SaaS-style interaction patterns.
- 2026-02-27: Extracted `CreateGatewayAppOptions` into `apps/gateway-orchestrator/src/app_types.ts`, reducing app-factory type noise and making gateway composition dependencies easier to evolve independently.
- 2026-02-27: Hardened worker Codex bootstrap with `ensureWorkerCodexRuntime` so failed Codex auth initialization now cleanly drops Codex chat runtime before hybrid LLM construction, preventing stale Codex handles from being retained in worker execution paths.
- 2026-02-27: Extracted root/UI/health handlers into `registerCoreRoutes` (`apps/gateway-orchestrator/src/routes/core_routes.ts`), leaving `createGatewayApp` focused on composing route modules and dependency wiring.
- 2026-02-27: Extracted heartbeat API handlers into `registerHeartbeatRoutes` (`apps/gateway-orchestrator/src/routes/heartbeat_routes.ts`) so heartbeat config/run validation and route behavior are maintained as a separate composition unit.
- 2026-02-27: Extracted identity/inbound/WhatsApp live/jobs APIs into `registerChannelRoutes` (`apps/gateway-orchestrator/src/routes/channel_routes.ts`), preserving existing Baileys inbound authorization, QR status rendering, and async job response semantics while reducing route density in `createGatewayApp`.
- 2026-02-27: Extracted memory endpoints into `registerMemoryRoutes` (`apps/gateway-orchestrator/src/routes/memory_routes.ts`) so compaction/checkpoint and memory retrieval/write handlers are maintained separately from gateway app bootstrap wiring.
- 2026-02-27: Extracted OpenAI/Codex auth HTTP surface into `registerAuthRoutes` (`apps/gateway-orchestrator/src/routes/auth_routes.ts`) and rewired `createGatewayApp` to compose auth dependencies separately from core message/job routes.
- 2026-02-27: Extracted stream/run/supervisor/approval routes from `createGatewayApp` into `registerObservabilityRoutes` (`apps/gateway-orchestrator/src/routes/observability_routes.ts`), reducing app-level route clutter while preserving existing API response/validation behavior.
- 2026-02-27: Extracted planner-fallback routing from `GatewayService.handleInbound` into `handlePlannerFallbackRoutes` and fixed async helper returns to `return await` in the `try/finally` flow so run-ledger persistence/finalization remains sequenced and avoids concurrent run-file write races.
- 2026-02-26: Unified orchestrator typing by moving planner/auth preference contracts into shared phase types and reusing them across gateway app + service composition paths to reduce duplicate type maintenance during ongoing refactor.
- 2026-02-26: Refactored UI shell by extracting shared header/navigation rendering into a reusable helper used by `/ui`, `/ui/transcripts`, and `/ui/console`, reducing cross-page duplication while preserving behavior.
- 2026-02-26: Extracted planner-primary routing (`clarify`, `status_query`, `web_research`) into a dedicated helper in gateway service, improving phase separation between planning decisions and downstream route/persist behavior.
- 2026-02-26: Extracted pre-planner directive surface from gateway inbound flow into a dedicated helper covering paging, command execution, implicit approvals, and progress-query responses, keeping planner routing logic cleaner without behavior changes.
- 2026-02-26: Reduced gateway orchestration entrypoint complexity by extracting session-busy and explicit async-job request branches from `handleInbound` into dedicated helpers while preserving queueing and acknowledgement behavior.
- 2026-02-26: Updated architecture docs to explicitly lock conditional hybrid planning (worker can propose, gateway decides/locks execution) and documented WASM sandbox as a deferred post-refactor implementation track.
- 2026-02-26: Refactored worker runtime into execution modules (`createWorkerProcessor`, `createWorkerStatusHandler`) and decoupled RunSpec executor to service interfaces, preserving existing job semantics while clarifying worker lifecycle boundaries.
- 2026-02-26: Refactored gateway inbound entry into explicit normalize/session orchestration phases (`runNormalizePhase`, `runSessionPhase`) so run-ledger start/marker logic is modular and reusable while downstream command/planner routing behavior remains unchanged.
- 2026-02-26: Added hybrid planning contract schemas (`PlanProposal`, `PlanDecision`, `RunSpecLock`) to lock gateway-authoritative run-spec handoff semantics between orchestrator and worker, with dedicated unit tests.
- 2026-02-26: Removed automatic partial `creds.json` reset on Baileys connect after observing a post-scan regression loop where valid transitional auth could be erased and trigger repeated re-registration; runtime now relies on explicit `515` restart recovery without destructive auth-dir mutation.
- 2026-02-26: Added explicit Baileys `stream:error` restart handling for code `515` so gateway now force-recycles socket and reconnects even when Baileys does not emit `connection:"close"`; also expanded disconnect-code parsing (`error.data.attrs.code`) and locked behavior with unit coverage.
- 2026-02-26: Added Baileys interrupted-pairing recovery in runtime startup: when auth creds are partially persisted (`registered=false` but `me/account` present), gateway now backs up stale `creds.json` and forces a clean relink path so WhatsApp does not remain stuck in `connecting` with repeated 428/1006 loop errors and no QR refresh.
- 2026-02-26: Split web UI into dedicated surfaces: `/ui` dashboard for connection/binding controls, `/ui/transcripts` for cross-source transcript viewing, and `/ui/console` for operational stream/testing; console log rendering now caps in-browser history to the latest 500 entries to avoid unbounded growth.
- 2026-02-26: Hardened approval + long-run UX after WhatsApp transcript review: `yes/no` approvals now resolve before planner routing (no accidental clarify loop), balanced mode now requires a single file-write approval for `web_to_file` (send step auto-continues), `web_to_file` uses `auto` provider routing, and RunSpec failures now mark worker jobs as failed instead of succeeded.
- 2026-02-26: Completed RunSpec v1 baseline for long-task orchestration: added schema/contracts, durable run-spec store, generic worker step executor, migrated `web_to_file` to RunSpec steps, added per-step approval checkpoint sequencing, exposed RunSpec details on `/v1/runs/:runId`, and added `/ui` run timeline controls.
- 2026-02-26: Added calendar command flow (`/calendar add|list|cancel`) backed by reminder state, plus workspace-scoped file attachment delivery (`/file send`) over WhatsApp with approval support and `.md/.txt/.doc` guardrails.
- 2026-02-26: Added planner-driven research-to-file orchestration (`web_to_file`) so a natural-language request can trigger search + document synthesis + workspace write + WhatsApp attachment delivery in one worker run, with approval gating for side effects.

## Completion Checklist Template

Use this checklist whenever a phase is completed:

1. Automated tests executed and passing.
2. Manual checklist executed and recorded.
3. `docs/changelog.md` updated with phase/task completion entry.
4. `docs/progress.md` status and dates updated.
5. Commit includes docs + implementation evidence for that phase.
